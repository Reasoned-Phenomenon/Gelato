<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gelato.app.rwmatr.order.dao.RwmatroMapper">

	<select id="rwmatrOrderList" resultType="RwmatroVO">
		SELECT RD.ORDER_ID AS ORDER_ID, 
       		   RD.rwmatr_order_deta_id AS rwmatr_order_deta_id, 
		       R.NM, R.RWMATR_ID AS RWMATR_ID, 
		       TO_CHAR(RD.UNTPRC, '999,999,999') AS UNTPRC, 
		       TO_CHAR(RD.QY, '999,999,999') AS QY,
		       V.VEND_ID AS VEND_ID, 
		       V.VEND_NAME AS VEND_NAME, 
		       RO.ORDER_DT AS ORDER_DT, 
		       RO.DUDT AS DUDT,
               TO_CHAR(RD.QY*RD.UNTPRC, '999,999,999') AS TOTALPRICE
		FROM RWMATR_ORDER_DETA RD JOIN RWMATR_ORDER RO
		    ON(RD.ORDER_ID = RO.ORDER_ID)
		JOIN RWMATR R
		    ON(RD.RWMATR_ID = R.RWMATR_ID)
		JOIN VEND V
		    ON(R.VEND_ID = V.VEND_ID)
	    <where>
	    	<if test="startDate != ''">
	    		<![CDATA[TRUNC(RO.ORDER_DT) >= to_date(#{startDate})]]>
	    	</if>
	    	<if test="endDate != ''">
	    		AND <![CDATA[TRUNC(RO.ORDER_DT) <= to_date(#{endDate})]]>
	    	</if>
			<if test="rwmName != ''">
				AND R.NM LIKE '%'||#{rwmName}||'%'
			</if>
			<if test="vendName != ''">
				AND V.VEND_NAME LIKE '%'||#{vendName}||'%'
			</if>
		</where>
		ORDER BY 1 DESC
	</select>
	
	<select id="selectVendList" resultType="RwmatroVO">
		SELECT VEND_ID, 
			   VEND_NAME, 
			   REMK
		FROM VEND
		WHERE FG = 'VEND01'
		<if test="vendName != ''">
			AND VEND_NAME LIKE '%'||#{vendName}||'%'
		</if>
	</select>
	
	<insert id="insertRwmatro" parameterType="RwmatroVO">
		<selectKey keyProperty="orderId" resultType="string" order="BEFORE">
			SELECT 'OAF-'||
				    TO_CHAR(SYSDATE,'YYYYMMDD-')||
				    LPAD(MAX(TO_NUMBER(SUBSTR(ORDER_ID, -3))) +1, 3, 0) 
			AS ORDER_ID
			FROM RWMATR_ORDER
		</selectKey>
		INSERT INTO RWMATR_ORDER (
									ORDER_ID,
									ORDER_DT, 
									DUDT) 
						   VALUES(
						   			#{orderId},
						   			sysdate,
						   			#{dudt}
						   		 )
	</insert>
	
	<insert id="insertRwmatroDeta" parameterType="RwmatroVO">
		<selectKey keyProperty="rwmatrOrderDetaId" resultType="string" order="BEFORE">
			SELECT 
	        'OAD-'||TO_CHAR(SYSDATE,'YYYYMMDD-')|| 
	        LPAD((SELECT NVL(MAX(TO_NUMBER(SUBSTR(ROD.RWMATR_ORDER_DETA_ID, -3)))+1, 0) 
	        		AS RWMATR_ORDER_DETA_ID
		        FROM RWMATR_ORDER RO 
		        	JOIN RWMATR_ORDER_DETA ROD
			        ON RO.ORDER_ID = ROD.ORDER_ID
			        WHERE TRUNC(ORDER_DT) = TRUNC(SYSDATE)), 3, 0) 
			        AS rwmatr_order_deta_id
	        FROM DUAL
		</selectKey>
		INSERT INTO RWMATR_ORDER_DETA (
										RWMATR_ORDER_DETA_ID,
										ORDER_ID, 
										RWMATR_ID,
										UNTPRC, 
										QY) 
								VALUES (
										#{rwmatrOrderDetaId},
										#{orderId},
										#{rwmatrId},
										#{untprc},
										#{qy}
										)
	</insert>
	
	<update id="updateRwmatro" parameterType="RwmatroVO">
		UPDATE RWMATR_ORDER SET DUDT = #{dudt}
		WHERE ORDER_ID = #{orderId}
	</update>
	
	<update id="updateRwmatroDeta" parameterType="RwmatroVO">
		UPDATE RWMATR_ORDER_DETA SET RWMATR_ID = #{rwmatrId},
									 UNTPRC = #{untprc},
									 qy = #{qy}
		WHERE RWMATR_ORDER_DETA_ID = #{rwmatrOrderDetaId}
	</update>
	
	<delete id="deleteRwmatroDeta" parameterType="RwmatroVO">
		DELETE FROM RWMATR_ORDER_DETA 
		WHERE RWMATR_ORDER_DETA_ID = #{rwmatrOrderDetaId}
	</delete>

</mapper>